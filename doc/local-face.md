# Настройка локального ввода-вывода

Один из основных сценариев использования голосового ассистента - использование микрофонов и динамиков устройства, на
котором запущен ассистент для ведения диалога с пользователем. Здесь и далее такой сценарий будет называться работой с
*локальным (local)* вводом/выводом, в противовес работе с
*удалёнными (remote)* устройствами - через HTTP API или, например, через мессенджеры. Работу с локальным вводом/выводом
осуществляет плагин `face_local`.

Локальный ввод-вывод может работать одновременно с различными удалёнными методами работы. Например, можно установить
сервер ассистента на компьютер в одной комнате, подключить по HTTP более слабое устройство (на момент написания этого
документа, клиентское приложение для запуска просто на устройстве, не через браузер, пока не реализовано) в соседней
комнате и одновременно запустить на сервере Telegram-бота.

## Docker

Локальный ввод-вывод может работать при запуске сервера ассистента через Docker-контейнер. Для этого нужно дать
контейнеру доступ к звуковой системе машины, на которой он выполняется. На некоторых версиях Linux для этого достаточно
добавить следующие опции при запуске контейнера:

- Дать контейнеру доступ к звуковым устройствам: `--device /dev/snd:/dev/snd`
- Добавить пользователя, от имени которого выполняется процесс в контейнере, в группу `audio`, чтобы у него были права
  на работу с этими устройствами: `--group-add audio`

В результате команда может выглядеть примерно так:

```shell
docker run -it --publish 8086:8086 -v "$HOME/irene:/irene" \
  --device /dev/snd:/dev/snd --group-add audio \
  alexeybond/irene:latest
```

Если в Вашем случае этого оказалось не достаточно и Вам удалось найти решение, не стесняйтесь дополнить документацию,
открыв pull request с нужными дополнениями или issue с описанием того, как можно улучшить документацию.

## Конфигурация

Конфигурация плагина `face_local` позволяет изменять то, какие методы используются ассистентом для ввода команд и вывода
ответов. Конфигурация, поставляемая по-умолчанию, должна работать корректно в большинстве случаев, однако её может
потребоваться как для исправления неполадок в тех случаях, когда она всё-таки не работает, так и для удовлетворения
вкусовых предпочтений пользователя, например, выбора более приятного TTS или STT движка.

Плагин `face_local` позволяет выбрать один метод ввода команд (как правило, STT движок в сочетании со средствами
получения данных с микрофона) и один или несколько методов вывода (как правило, их минимум два - один для вывода готовых
звуковых файлов, наподобие сигнала таймера и один для вывода речи ассистента).

### Методы ввода

#### vosk+sounddevice

Используется по-умолчанию.

Прослушивает микрофон при помощи библиотеки sounddevice (обёртки для portaudio) и распознаёт голосовые команды при
помощи vosk.

Параметры устанавливаются в конфигурации плагина `local_input_sounddevice_vosk`.

Пример настройки в конфигурации `face_local`:

```yaml
input:
  type: vosk+sounddevice
```

### Методы вывода

#### sounddevice

Используется по-умолчанию.

Выводит звук с использованием библиотеки sounddevice (обёртки для portaudio).

Параметры устанавливаются в конфигурации плагина `local_output_sounddevice`. В случае, если Вы сталкиваетесь с
проблемами при окончании воспроизведения звуков или фраз ассистента (небольшое зависание после воспроизведения или
наоборот, пропуск конца фразы), то обратите внимание на настройки этого плагина.

Пример настройки в конфигурации `face_local`:

```yaml
outputs:
  - type: sounddevice
```

#### tts-immediate, tts-file, tts

Используется по-умолчанию.

Добавляется плагином `plugin_local_output_tts`. Глобальных настроек не имеет.

Выводят голосовые ответы ассистента, озвучивая их с помощью выбранного TTS-движка.

- `tts-immediate` используется для TTS-движков, умеющих самостоятельно воспроизводить озвученный текст.
- `tts-file` используется когда TTS-движок не обладает собственной функциональностью для воспроизведения звука, вместо
  этого результат озвучения записывается в файл и воспроизводится при помощи выбранного метода воспроизведения звука. В
  качестве дополнительного параметра требуется указание используемого метода воспроизведения аудио-файлов.
- `tts` пытается автоматически определить, подходящий метод воспроизведения для указанного TTS-движка,
  предпочитая `tts-immediate`.

Пример настройки в конфигурации `face_local` для TTS-движка, умеющего воспроизводить звук:

```yaml
outputs:
  - tts:
      type: pyttsx
    type: tts-immediate
```

Пример настройки в конфигурации `face_local` для TTS-движка, не имеющего собственной функциональности воспроизведения
звука:

```yaml
outputs:
  - player:
      # Точно такой же объект, как при создании канала вывода аудио
      type: sounddevice
    tts:
      type: silero_v3
    type: tts-file
```

`tts-file` можно использовать для TTS-движков, способных и писать результат в файл и воспроизводить его если вариант с
записью в файл по тем или иным причинам более предпочтителен. Например, если возникают проблемы со встроенной в движок
функциональностью воспроизведения или если из-за низкой производительности необходимо кеширование результатов работы
TTS (на момент написания этого документа, пока не реализовано).
